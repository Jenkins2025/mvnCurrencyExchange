pipeline {
     agent any

     environment{
          DOCKER_TAG = getDockerTag()
          mavenHome = tool 'myMaven4'
		PATH = "$mavenHome/bin:$PATH"
     }
       
     stages {

         stage('Checkout') {
			steps {
				sh 'mvn --version'
				
			}
		}

		stage('Compile Decode') {
			steps {
				sh "mvn clean package"
			}
		}

         stage( 'Build Docker Image'){
             steps{
                 sh "docker build . -t agunuworld/moneychange:${DOCKER_TAG} "
             }
         }
      
      stage('Push Docker Image'){
          steps{
              withCredentials([string(credentialsId: 'dockerAuthenticationpublic', variable: 'dockerAuthenticationpublic')])  {
              sh "docker login -u agunuworld -p ${dockerAuthenticationpublic}"
           }
          sh "docker push agunuworld/moneychange:${DOCKER_TAG} "
          }
          }
       
       stage('Deploy To Kubernetes'){
           steps{
               sh "chmod +x changeTag.sh"
               sh "./changeTag.sh ${DOCKER_TAG}"
               sshagent(['eksclimasternodes']) {
               sh "scp -o StrictHostKeyChecking=no services.yml ns-and-sa.yaml node-app-pod.yml ec2-user@3.135.209.242:/home/ec2-user/"
               script{
                   try{
                       sh "ssh ec2-user@3.135.209.242 kubectl apply -f ."
                   }catch(error){
                       sh "ssh ec2-user@3.135.209.242 kubectl create -f ."
                   }
               }
            }
           }
       }
      
     }
}

def getDockerTag(){
    def tag  = sh script: 'git rev-parse HEAD', returnStdout: true
    return tag
}

